name: Multi-Platform Build

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

jobs:
  # è½»é‡çº§å·¥å…·æ„å»º (Gemini-STTå’Œå·¥å…·è„šæœ¬)
  build-light-tools:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64 build
          - os: ubuntu-22.04
            arch: x64
            platform: linux-x64
            setup_python_arch: x64
          # Linux ARM64 build (å®˜æ–¹æ”¯æŒï¼Œ2025å¹´1æœˆå…¬å…±ä»“åº“å…è´¹)
          - os: ubuntu-22.04-arm
            arch: arm64
            platform: linux-arm64
            setup_python_arch: arm64
          # Windows builds
          - os: windows-2022
            arch: x64
            platform: windows-x64
            setup_python_arch: x64
          # macOS builds
          - os: macos-15
            arch: arm64
            platform: macos-arm64
            setup_python_arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: ${{ matrix.setup_python_arch }}

      - name: Set commit version
        id: version
        run: |
          VERSION=$(git log --format=%B -1 | head -1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller requests urllib3 tqdm huggingface_hub pyyaml

      - name: Build gemini-stt
        run: |
          pyinstaller --onefile --hidden-import=requests,urllib3,json,argparse,mimetypes,datetime,sys,os,time,re --strip gemini-stt.py --distpath dist/${{ matrix.platform }}

      - name: Build convert_whisper
        run: |
          pyinstaller --onefile --hidden-import=huggingface_hub,tqdm,shutil,pathlib,argparse,os --strip tools/convert_whisper.py --distpath dist/${{ matrix.platform }}

      - name: Build get_Pyannote_model
        run: |
          pyinstaller --onefile --hidden-import=huggingface_hub,yaml,shutil,subprocess,pathlib,argparse,os,sys --strip tools/get_Pyannote_model.py --distpath dist/${{ matrix.platform }}

      # å•ç‹¬ä¸Šä¼ æ¯ä¸ªè½»é‡çº§å·¥å…· (æ–‡ä»¶å_py-æ¶æ„-ç‰ˆæœ¬å·)
      - name: Upload gemini-stt
        uses: actions/upload-artifact@v4
        with:
          name: gemini-stt_py-${{ matrix.platform }}-${{ steps.version.outputs.version }}
          path: dist/${{ matrix.platform }}/gemini-stt*
          compression-level: 0

      - name: Upload convert_whisper
        uses: actions/upload-artifact@v4
        with:
          name: convert_whisper_py-${{ matrix.platform }}-${{ steps.version.outputs.version }}
          path: dist/${{ matrix.platform }}/convert_whisper*
          compression-level: 0

      - name: Upload get_Pyannote_model
        uses: actions/upload-artifact@v4
        with:
          name: get_Pyannote_model_py-${{ matrix.platform }}-${{ steps.version.outputs.version }}
          path: dist/${{ matrix.platform }}/get_Pyannote_model*
          compression-level: 0

  # STTä¸»ç¨‹åºæ„å»º (é‡å‹ä¾èµ–)
  build-stt:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64 build
          - os: ubuntu-22.04
            arch: x64
            platform: linux-x64
            setup_python_arch: x64
          # Linux ARM64 build (å®˜æ–¹æ”¯æŒï¼Œ2025å¹´1æœˆå…¬å…±ä»“åº“å…è´¹)
          - os: ubuntu-22.04-arm
            arch: arm64
            platform: linux-arm64
            setup_python_arch: arm64
          # Windows builds
          - os: windows-2022
            arch: x64
            platform: windows-x64
            setup_python_arch: x64
          # macOS builds
          - os: macos-15
            arch: arm64
            platform: macos-arm64
            setup_python_arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: ${{ matrix.setup_python_arch }}

      - name: Set commit version
        id: version
        run: |
          VERSION=$(git log --format=%B -1 | head -1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libffi-dev libasound2-dev portaudio19-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install portaudio

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller numpy soundfile faster-whisper pyyaml
          # å¯¹äºéARM Linuxï¼Œå®‰è£…torchå’Œç›¸å…³ä¾èµ–
          if [[ "${{ matrix.platform }}" != "linux-arm64" ]]; then
            # ä½¿ç”¨CPUç‰ˆæœ¬çš„torchä»¥ç¡®ä¿å…¼å®¹æ€§å’Œå‡å°åŒ…å¤§å°
            python -m pip install torch torchaudio --index-url https://download.pytorch.org/whl/cpu
            python -m pip install ctranslate2
            # å°è¯•å®‰è£…pyannote.audioï¼Œå¤±è´¥æ—¶ç»§ç»­
            python -m pip install pyannote.audio==3.1.1 || echo "Warning: pyannote.audio installation failed, continuing..."
          else
            echo "Skipping torch/pyannote for ARM64 Linux due to compatibility issues"
            echo "ARM64 Linux build will have limited functionality (no speaker diarization)"
          fi

      - name: Build STT
        run: |
          # æ ¹æ®å¹³å°è°ƒæ•´éšè—å¯¼å…¥
          if [[ "${{ matrix.platform }}" != "linux-arm64" ]]; then
            # å®Œæ•´ç‰ˆæœ¬ï¼ˆåŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰
            pyinstaller --onefile --hidden-import=faster_whisper,soundfile,numpy,ctranslate2,pyannote.audio,torch,torchaudio,yaml,tempfile,pathlib,typing,io,logging,argparse,json,datetime,time,os,sys,subprocess,shutil --strip stt.py --distpath dist/${{ matrix.platform }}
          else
            # ARM64ç®€åŒ–ç‰ˆæœ¬ï¼ˆæ— torch/pyannoteæ”¯æŒï¼‰
            pyinstaller --onefile --hidden-import=faster_whisper,soundfile,numpy,yaml,tempfile,pathlib,typing,io,logging,argparse,json,datetime,time,os,sys,subprocess,shutil --strip stt.py --distpath dist/${{ matrix.platform }}
          fi

      - name: Upload STT
        uses: actions/upload-artifact@v4
        with:
          name: stt_py-${{ matrix.platform }}-${{ steps.version.outputs.version }}
          path: dist/${{ matrix.platform }}/*
          compression-level: 0

  # åŒå¹³å°å…¨å¥—å·¥å…·æ‰“åŒ… (SKY-STT-all)
  create-platform-bundles:
    needs: [build-light-tools, build-stt]
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        platform: [linux-x64, linux-arm64, windows-x64, macos-arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set commit version
        id: version
        run: |
          VERSION=$(git log --format=%B -1 | head -1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      # ä¸‹è½½è¯¥å¹³å°çš„æ‰€æœ‰å·¥å…·
      - name: Download light tools for platform
        uses: actions/download-artifact@v4
        with:
          pattern: "*_py-${{ matrix.platform }}-*"
          path: platform-bundle/
          merge-multiple: true

      - name: Download STT for platform
        uses: actions/download-artifact@v4
        with:
          name: stt_py-${{ matrix.platform }}-${{ steps.version.outputs.version }}
          path: platform-bundle/

      # ä¸Šä¼ å¹³å°å…¨å¥—åŒ… (ALL-ä»“åº“åå­—-æ¶æ„-ç‰ˆæœ¬å·)
      - name: Upload SKY-STT Platform Bundle
        uses: actions/upload-artifact@v4
        with:
          name: ALL-SKY-STT-${{ matrix.platform }}-${{ steps.version.outputs.version }}
          path: platform-bundle/*
          compression-level: 0

  # å…¨å¹³å°åˆé›†æ‰“åŒ…
  create-release-bundle:
    needs: [create-platform-bundles]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set commit version
        id: version
        run: |
          VERSION=$(git log --format=%B -1 | head -1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      # ä¸‹è½½æ‰€æœ‰ALL-SKY-STTå¹³å°åŒ…
      - name: Download all ALL-SKY-STT platform bundles
        uses: actions/download-artifact@v4
        with:
          pattern: ALL-SKY-STT-*
          path: release-bundle/
          merge-multiple: false

      # åˆ›å»ºå®Œæ•´å‘å¸ƒåŒ…
      - name: Create complete release bundle
        run: |
          mkdir -p complete-release
          # é‡æ–°ç»„ç»‡ç›®å½•ç»“æ„
          for platform in linux-x64 linux-arm64 windows-x64 macos-arm64; do
            mkdir -p "complete-release/$platform"
            
            # å¤åˆ¶ALL-SKY-STTå¹³å°åŒ… (åŒ…å«æ‰€æœ‰4ä¸ªå·¥å…·)
            if [ -d "release-bundle/ALL-SKY-STT-$platform-${{ steps.version.outputs.version }}" ]; then
              cp -r "release-bundle/ALL-SKY-STT-$platform-${{ steps.version.outputs.version }}/"* "complete-release/$platform/"
            fi
          done

      - name: Upload Complete Release Bundle
        uses: actions/upload-artifact@v4
        with:
          name: FULL-SKY-STT-${{ steps.version.outputs.version }}
          path: complete-release/*
          compression-level: 0

  # Releaseå‘å¸ƒ (ä»…åœ¨releaseè§¦å‘æ—¶æ‰§è¡Œ)
  publish-release:
    if: github.event_name == 'release'
    needs: [create-release-bundle]
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set commit version
        id: version
        run: |
          VERSION=$(git log --format=%B -1 | head -1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      # ä¸‹è½½æ‰€æœ‰å•ç‹¬ç¨‹åºartifacts
      - name: Download all single program artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*_py-*"
          path: release-assets/single/
          merge-multiple: false

      # ä¸‹è½½å®Œæ•´å‘å¸ƒåŒ…
      - name: Download complete release bundle
        uses: actions/download-artifact@v4
        with:
          name: FULL-SKY-STT-${{ steps.version.outputs.version }}
          path: release-assets/complete/

      # åˆ›å»ºå¹³å°ZIPåŒ… (ç»Ÿä¸€ZIPæ ¼å¼ï¼Œé¿å…åŒé‡å‹ç¼©)
      - name: Create platform-specific archives
        run: |
          cd release-assets/complete
          for platform in linux-x64 linux-arm64 windows-x64 macos-arm64; do
            if [ -d "$platform" ]; then
              zip -r "../sky-stt-$platform-${{ steps.version.outputs.version }}.zip" "$platform"/*
            fi
          done

      # ä¸Šä¼ åˆ°Release (ç»Ÿä¸€ZIPæ ¼å¼)
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*.zip
          name: "SKY-STT Release ${{ steps.version.outputs.version }}"
          body: |
            ## SKY-STT Multi-Platform Release ${{ steps.version.outputs.version }}
            
            ### ğŸ“¦ æ”¯æŒçš„å¹³å°
            - **Linux x64**: `sky-stt-linux-x64-${{ steps.version.outputs.version }}.zip`
            - **Linux ARM64**: `sky-stt-linux-arm64-${{ steps.version.outputs.version }}.zip`
            - **Windows x64**: `sky-stt-windows-x64-${{ steps.version.outputs.version }}.zip`
            - **macOS ARM64**: `sky-stt-macos-arm64-${{ steps.version.outputs.version }}.zip`
            
            ### ğŸ› ï¸ åŒ…å«å·¥å…·
            - **stt**: ä¸»STTå¼•æ“ï¼ŒåŸºäºFasterWhisper + Pyannoteï¼Œæ”¯æŒæœ¬åœ°è¯­éŸ³è¯†åˆ«å’Œè¯´è¯äººåˆ†å‰²
            - **gemini-stt**: åŸºäºGoogle Gemini APIçš„äº‘ç«¯STTå¼•æ“ï¼Œæ”¯æŒéŸ³é¢‘å’Œè§†é¢‘æ–‡ä»¶
            - **convert_whisper**: Whisperæ¨¡å‹è½¬æ¢å·¥å…·ï¼Œè‡ªåŠ¨ä¸‹è½½å¹¶è½¬æ¢ä¸ºfaster-whisperæ ¼å¼
            - **get_Pyannote_model**: Pyannoteæ¨¡å‹ç®¡ç†å·¥å…·ï¼Œä¸€é”®ä¸‹è½½å’Œé…ç½®è¯´è¯äººåˆ†å‰²æ¨¡å‹
            
            æ¯ä¸ªå‹ç¼©åŒ…åŒ…å«å¯¹åº”å¹³å°çš„æ‰€æœ‰4ä¸ªå·¥å…·çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚
          tag_name: ${{ github.ref }}