name: Multi-Platform Build

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

jobs:
  # Gemini-STT æ„å»º (è½»é‡çº§äº‘ç«¯è½¬å½•å·¥å…·)
  build-gemini-stt:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux-x64
            setup_python_arch: x64
          - os: windows-2022
            platform: windows-x64
            setup_python_arch: x64
          - os: macos-15
            platform: macos-arm64
            setup_python_arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: ${{ matrix.setup_python_arch }}

      - name: Set commit version
        id: version
        run: |
          VERSION=$(git log --format=%B -1 | head -1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller requests urllib3

      - name: Build gemini-stt
        shell: bash
        run: |
          pyinstaller --onefile --hidden-import=requests,urllib3,json,argparse,mimetypes,datetime,sys,os,time,re --strip gemini-stt.py --distpath dist/${{ matrix.platform }}

      - name: Upload gemini-stt
        uses: actions/upload-artifact@v4
        with:
          name: gemini-stt_py-${{ matrix.platform }}-${{ steps.version.outputs.version }}
          path: dist/${{ matrix.platform }}/gemini-stt*
          compression-level: 0

  # Convert Whisper æ¨¡å‹è½¬æ¢å·¥å…·æ„å»º
  build-convert-whisper:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux-x64
            setup_python_arch: x64
          - os: windows-2022
            platform: windows-x64
            setup_python_arch: x64
          - os: macos-15
            platform: macos-arm64
            setup_python_arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: ${{ matrix.setup_python_arch }}

      - name: Set commit version
        id: version
        run: |
          VERSION=$(git log --format=%B -1 | head -1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller huggingface_hub tqdm

      - name: Build convert_whisper
        shell: bash
        run: |
          pyinstaller --onefile --hidden-import=huggingface_hub,tqdm,shutil,pathlib,argparse,os --strip tools/convert_whisper.py --distpath dist/${{ matrix.platform }}

      - name: Upload convert_whisper
        uses: actions/upload-artifact@v4
        with:
          name: convert_whisper_py-${{ matrix.platform }}-${{ steps.version.outputs.version }}
          path: dist/${{ matrix.platform }}/convert_whisper*
          compression-level: 0

  # Pyannote æ¨¡å‹ç®¡ç†å·¥å…·æ„å»º
  build-get-pyannote-model:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux-x64
            setup_python_arch: x64
          - os: windows-2022
            platform: windows-x64
            setup_python_arch: x64
          - os: macos-15
            platform: macos-arm64
            setup_python_arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: ${{ matrix.setup_python_arch }}

      - name: Set commit version
        id: version
        run: |
          VERSION=$(git log --format=%B -1 | head -1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller huggingface_hub pyyaml

      - name: Build get_Pyannote_model
        shell: bash
        run: |
          pyinstaller --onefile --hidden-import=huggingface_hub,yaml,shutil,subprocess,pathlib,argparse,os,sys --strip tools/get_Pyannote_model.py --distpath dist/${{ matrix.platform }}

      - name: Upload get_Pyannote_model
        uses: actions/upload-artifact@v4
        with:
          name: get_Pyannote_model_py-${{ matrix.platform }}-${{ steps.version.outputs.version }}
          path: dist/${{ matrix.platform }}/get_Pyannote_model*
          compression-level: 0

  # STTä¸»ç¨‹åºæ„å»º (é‡å‹ä¾èµ–) - åŒç‰ˆæœ¬ç­–ç•¥
  build-stt:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64 - CPUç‰ˆæœ¬
          - os: ubuntu-22.04
            arch: x64
            platform: linux-x64-cpu
            torch_variant: cpu
            torch_index: "https://download.pytorch.org/whl/cpu"
            name_suffix: "CPU"
            setup_python_arch: x64
          # Linux x64 - CUDAç‰ˆæœ¬
          - os: ubuntu-22.04
            arch: x64
            platform: linux-x64-cuda
            torch_variant: cuda
            torch_index: "https://download.pytorch.org/whl/cu121"
            name_suffix: "CUDA"
            setup_python_arch: x64
          # Windows x64 - CPUç‰ˆæœ¬
          - os: windows-2022
            arch: x64
            platform: windows-x64-cpu
            torch_variant: cpu
            torch_index: "https://download.pytorch.org/whl/cpu"
            name_suffix: "CPU"
            setup_python_arch: x64
          # Windows x64 - CUDAç‰ˆæœ¬
          - os: windows-2022
            arch: x64
            platform: windows-x64-cuda
            torch_variant: cuda
            torch_index: "https://download.pytorch.org/whl/cu121"
            name_suffix: "CUDA"
            setup_python_arch: x64
          # macOS ARM64 - MPSç‰ˆæœ¬ (Apple Silicon GPUåŠ é€Ÿ)
          - os: macos-15
            arch: arm64
            platform: macos-arm64-mps
            torch_variant: mps
            torch_index: "default"
            name_suffix: "MPS"
            setup_python_arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: ${{ matrix.setup_python_arch }}

      - name: Set commit version
        id: version
        run: |
          VERSION=$(git log --format=%B -1 | head -1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libffi-dev libasound2-dev portaudio19-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install portaudio

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller numpy soundfile faster-whisper pyyaml
          
          # æ ¹æ®torchå˜ä½“å®‰è£…å¯¹åº”ç‰ˆæœ¬
          if [[ "${{ matrix.torch_index }}" == "default" ]]; then
            echo "Installing PyTorch with MPS support for macOS Apple Silicon"
            python -m pip install torch torchaudio
          else
            echo "Installing PyTorch ${{ matrix.torch_variant }} variant from ${{ matrix.torch_index }}"
            python -m pip install torch torchaudio --index-url ${{ matrix.torch_index }}
          fi
          
          # å®‰è£…å…±åŒä¾èµ–
          python -m pip install ctranslate2
          # å°è¯•å®‰è£…pyannote.audioï¼Œå¤±è´¥æ—¶ç»§ç»­
          python -m pip install pyannote.audio==3.1.1 || echo "Warning: pyannote.audio installation failed, continuing..."

      - name: Build STT
        shell: bash
        run: |
          echo "Building STT for ${{ matrix.platform }} with ${{ matrix.torch_variant }} support"
          pyinstaller --onefile --hidden-import=faster_whisper,soundfile,numpy,ctranslate2,pyannote.audio,torch,torchaudio,yaml,tempfile,pathlib,typing,io,logging,argparse,json,datetime,time,os,sys,subprocess,shutil --strip stt.py --distpath dist/${{ matrix.platform }}

      - name: Upload STT
        uses: actions/upload-artifact@v4
        with:
          name: stt_py-${{ matrix.platform }}-${{ matrix.name_suffix }}-${{ steps.version.outputs.version }}
          path: dist/${{ matrix.platform }}/*
          compression-level: 0

  # åˆ†ç‰ˆæœ¬å¹³å°å·¥å…·æ‰“åŒ… (SKY-STT-all)
  create-platform-bundles:
    needs: [build-gemini-stt, build-convert-whisper, build-get-pyannote-model, build-stt]
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          # Linuxç‰ˆæœ¬
          - base_platform: linux-x64
            full_platform: linux-x64-cpu
            suffix: CPU
            light_pattern: "*_py-linux-x64-*"
          - base_platform: linux-x64
            full_platform: linux-x64-cuda
            suffix: CUDA
            light_pattern: "*_py-linux-x64-*"
          # Windowsç‰ˆæœ¬
          - base_platform: windows-x64
            full_platform: windows-x64-cpu
            suffix: CPU
            light_pattern: "*_py-windows-x64-*"
          - base_platform: windows-x64
            full_platform: windows-x64-cuda
            suffix: CUDA
            light_pattern: "*_py-windows-x64-*"
          # macOSç‰ˆæœ¬
          - base_platform: macos-arm64
            full_platform: macos-arm64-mps
            suffix: MPS
            light_pattern: "*_py-macos-arm64-*"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set commit version
        id: version
        run: |
          VERSION=$(git log --format=%B -1 | head -1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      # ä¸‹è½½è¯¥å¹³å°çš„è½»é‡çº§å·¥å…·
      - name: Download light tools for platform
        uses: actions/download-artifact@v4
        with:
          pattern: "${{ matrix.light_pattern }}"
          path: platform-bundle/
          merge-multiple: true

      # ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„STT
      - name: Download STT for platform
        uses: actions/download-artifact@v4
        with:
          name: stt_py-${{ matrix.full_platform }}-${{ matrix.suffix }}-${{ steps.version.outputs.version }}
          path: platform-bundle/

      # ä¸Šä¼ å¹³å°å…¨å¥—åŒ… (ALL-ä»“åº“åå­—-å®Œæ•´å¹³å°-ç‰ˆæœ¬å·)
      - name: Upload SKY-STT Platform Bundle
        uses: actions/upload-artifact@v4
        with:
          name: ALL-SKY-STT-${{ matrix.full_platform }}-${{ matrix.suffix }}-${{ steps.version.outputs.version }}
          path: platform-bundle/*
          compression-level: 0

  # å…¨å¹³å°åˆé›†æ‰“åŒ…
  create-release-bundle:
    needs: [create-platform-bundles]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set commit version
        id: version
        run: |
          VERSION=$(git log --format=%B -1 | head -1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      # ä¸‹è½½æ‰€æœ‰ALL-SKY-STTå¹³å°åŒ…
      - name: Download all ALL-SKY-STT platform bundles
        uses: actions/download-artifact@v4
        with:
          pattern: ALL-SKY-STT-*
          path: release-bundle/
          merge-multiple: false

      # åˆ›å»ºå®Œæ•´å‘å¸ƒåŒ…
      - name: Create complete release bundle
        run: |
          mkdir -p complete-release
          
          # é‡æ–°ç»„ç»‡ç›®å½•ç»“æ„ - ç°åœ¨åŒ…å«å¤šä¸ªç‰ˆæœ¬
          for variant in "linux-x64-cpu-CPU" "linux-x64-cuda-CUDA" "windows-x64-cpu-CPU" "windows-x64-cuda-CUDA" "macos-arm64-mps-MPS"; do
            IFS='-' read -r platform arch variant_type suffix <<< "$variant"
            full_platform="${platform}-${arch}-${variant_type}"
            
            mkdir -p "complete-release/$full_platform"
            
            # å¤åˆ¶ALL-SKY-STTå¹³å°åŒ… (åŒ…å«æ‰€æœ‰4ä¸ªå·¥å…·)
            bundle_name="ALL-SKY-STT-$full_platform-$suffix-${{ steps.version.outputs.version }}"
            if [ -d "release-bundle/$bundle_name" ]; then
              cp -r "release-bundle/$bundle_name/"* "complete-release/$full_platform/"
            fi
          done

      - name: Upload Complete Release Bundle
        uses: actions/upload-artifact@v4
        with:
          name: FULL-SKY-STT-${{ steps.version.outputs.version }}
          path: complete-release/*
          compression-level: 0

  # Releaseå‘å¸ƒ (ä»…åœ¨releaseè§¦å‘æ—¶æ‰§è¡Œ)
  publish-release:
    if: github.event_name == 'release'
    needs: [create-release-bundle]
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set commit version
        id: version
        run: |
          VERSION=$(git log --format=%B -1 | head -1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      # ä¸‹è½½æ‰€æœ‰å•ç‹¬ç¨‹åºartifacts
      - name: Download all single program artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*_py-*"
          path: release-assets/single/
          merge-multiple: false

      # ä¸‹è½½å®Œæ•´å‘å¸ƒåŒ…
      - name: Download complete release bundle
        uses: actions/download-artifact@v4
        with:
          name: FULL-SKY-STT-${{ steps.version.outputs.version }}
          path: release-assets/complete/

      # åˆ›å»ºå¹³å°ZIPåŒ… (ç»Ÿä¸€ZIPæ ¼å¼ï¼Œé¿å…åŒé‡å‹ç¼©)
      - name: Create platform-specific archives
        run: |
          cd release-assets/complete
          
          # ä¸ºæ¯ä¸ªå¹³å°å’Œç‰ˆæœ¬åˆ›å»ºZIPåŒ…
          for variant in linux-x64-cpu linux-x64-cuda windows-x64-cpu windows-x64-cuda macos-arm64-mps; do
            if [ -d "$variant" ]; then
              # æå–ç‰ˆæœ¬ä¿¡æ¯ç”¨äºå‘½å
              case "$variant" in
                *-cpu)    suffix="CPU" ;;
                *-cuda)   suffix="CUDA" ;;
                *-mps)    suffix="MPS" ;;
              esac
              
              zip -r "../sky-stt-$variant-$suffix-${{ steps.version.outputs.version }}.zip" "$variant"/*
            fi
          done

      # ä¸Šä¼ åˆ°Release (ç»Ÿä¸€ZIPæ ¼å¼)
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*.zip
          name: "SKY-STT Release ${{ steps.version.outputs.version }}"
          body: |
            ## SKY-STT Multi-Platform Release ${{ steps.version.outputs.version }}
            
            ### ğŸ¯ ç‰ˆæœ¬é€‰æ‹©æŒ‡å—
            - **éœ€è¦å…¼å®¹æ€§**ï¼šé€‰æ‹© CPU ç‰ˆæœ¬ (~200MB)
            - **æœ‰NVIDIAæ˜¾å¡**ï¼šé€‰æ‹© CUDA ç‰ˆæœ¬ (~2.5GBï¼Œ8å€æ€§èƒ½æå‡)
            - **macOSç”¨æˆ·**ï¼šé€‰æ‹© MPS ç‰ˆæœ¬ (~300MBï¼ŒApple Silicon GPUåŠ é€Ÿ)
            
            ### ğŸ“¦ æ”¯æŒçš„å¹³å°å’Œç‰ˆæœ¬
            
            #### Linux x64
            - **CPUç‰ˆæœ¬**: `sky-stt-linux-x64-cpu-CPU-${{ steps.version.outputs.version }}.zip` (å…¼å®¹æ‰€æœ‰è®¾å¤‡)
            - **CUDAç‰ˆæœ¬**: `sky-stt-linux-x64-cuda-CUDA-${{ steps.version.outputs.version }}.zip` (éœ€è¦NVIDIA GPU + CUDA 12.1+)
            
            #### Windows x64  
            - **CPUç‰ˆæœ¬**: `sky-stt-windows-x64-cpu-CPU-${{ steps.version.outputs.version }}.zip` (å…¼å®¹æ‰€æœ‰è®¾å¤‡)
            - **CUDAç‰ˆæœ¬**: `sky-stt-windows-x64-cuda-CUDA-${{ steps.version.outputs.version }}.zip` (éœ€è¦NVIDIA GPU + CUDA 12.1+)
            
            #### macOS ARM64 (Apple Silicon)
            - **MPSç‰ˆæœ¬**: `sky-stt-macos-arm64-mps-MPS-${{ steps.version.outputs.version }}.zip` (M1/M2/M3èŠ¯ç‰‡GPUåŠ é€Ÿ)
            
            ### ğŸ› ï¸ åŒ…å«å·¥å…·
            - **stt**: ä¸»STTå¼•æ“ï¼ŒåŸºäºFasterWhisper + Pyannoteï¼Œæ”¯æŒæœ¬åœ°è¯­éŸ³è¯†åˆ«å’Œè¯´è¯äººåˆ†å‰²
            - **gemini-stt**: åŸºäºGoogle Gemini APIçš„äº‘ç«¯STTå¼•æ“ï¼Œæ”¯æŒéŸ³é¢‘å’Œè§†é¢‘æ–‡ä»¶
            - **convert_whisper**: Whisperæ¨¡å‹è½¬æ¢å·¥å…·ï¼Œè‡ªåŠ¨ä¸‹è½½å¹¶è½¬æ¢ä¸ºfaster-whisperæ ¼å¼
            - **get_Pyannote_model**: Pyannoteæ¨¡å‹ç®¡ç†å·¥å…·ï¼Œä¸€é”®ä¸‹è½½å’Œé…ç½®è¯´è¯äººåˆ†å‰²æ¨¡å‹
            
            ### âš¡ æ€§èƒ½å¯¹æ¯”
            | ç‰ˆæœ¬ | å¤„ç†é€Ÿåº¦ | åŒ…å¤§å° | ç¡¬ä»¶è¦æ±‚ |
            |------|----------|--------|----------|
            | CPU | åŸºå‡†é€Ÿåº¦ | ~200MB | æ— ç‰¹æ®Šè¦æ±‚ |
            | CUDA | 8å€é€Ÿåº¦ | ~2.5GB | NVIDIA GPU |
            | MPS | 3å€é€Ÿåº¦ | ~300MB | Apple Silicon |
          tag_name: ${{ github.ref }}